<!doctype html>
<html>
<body>

<style type="text/css">
html,body{
    margin: 0;
    overflow: hidden;
}
rect {
    fill: #1f77b4;
}
</style>

<script type="text/javascript" src="crossfilter.js"></script>
<script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?2.8.1"></script>
<script type="text/javascript">
(function(){

    var win_w = window.innerWidth,
        win_h = window.innerHeight,
        columns = 20,
        rows = 20,
        wRatio = win_w/columns,
        hRatio = win_h/rows,
        size = Math.min(Math.floor(win_w/columns), Math.floor(win_h/rows));

    var svg = d3.select("body").append("svg:svg")
        .attr("width", win_w)
        .attr("height", win_h);

    d3.csv('test.csv', function (csv_data) {

      var cf = crossfilter(csv_data);
      var byTimestamp = cf.dimension(function (d) { return d.Timestamp; });
      var selection = svg.selectAll("rect");

      for (i = 0; i < 10; i++) {

        entities = []
        c = 0

        byTimestamp.filterExact(i);
        byTimestamp.top(Infinity).forEach(function(p, i) {
          c = c+1;
          entities.push({"timestamp": p.Timestamp, "type": p.Type, "left": p.Left, "top": p.Top});
        });
        byTimestamp.filterAll();

        console.log(i, c, entities);

        selection = selection.data(entities);

        //console.log(selection.data());

        selection.enter().append("rect")
            .attr("x", function (datum) { return datum.left * wRatio })
            .attr("y", function (datum) { return datum.top * hRatio })
            .attr("width", size)
            .attr("height", size)
            .transition()
            .duration(1000)
            .style("fill", function (datum) {
              if (datum.type == "Agent") {
                return "#0476C2"
              }
              else if (datum.type == "Food") {
                return "#3B7C7F"
              }
              else {
                return "#F2A038"
              }
            });;

        selection.exit()
            .style("fill", "#d62728")
            .transition()
            .duration(1000)
            .remove();

        setTimeout(arguments.callee, 1000);
      }
    });
})();
</script>
</body>
</html>
